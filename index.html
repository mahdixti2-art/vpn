import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc } from 'firebase/firestore';
import { Database, Clock, ShieldCheck, Zap, User, ArrowRight, CheckCircle, Send, CreditCard, Copy, Info, Camera, Image as ImageIcon, Loader2 } from 'lucide-react';

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'vpn-receipt-store';

export default function App() {
  const [user, setUser] = useState(null);
  const [step, setStep] = useState(1);
  const [months, setMonths] = useState(1);
  const [volume, setVolume] = useState(10);
  const [contact, setContact] = useState('');
  const [receiptImage, setReceiptImage] = useState(null);
  const [previewUrl, setPreviewUrl] = useState(null);
  const [loading, setLoading] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false);

  const BOT_TOKEN = "8302811186:AAEMBp9XhMGiW4WaBNF-F59BeDGa_gHV1To";
  const CHAT_ID = "8474397291";
  const CARD_NUMBER = "6219861908913584"; 
  const CARD_NAME = "ููุญู ูุฎุชุงุฑ";

  const BASE_PRICE = 30000;
  const PER_GB = 5000;
  const totalPrice = (months * BASE_PRICE) + (volume * PER_GB);

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  const handleImageChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setReceiptImage(file);
      setPreviewUrl(URL.createObjectURL(file));
    }
  };

  const copyToClipboard = (text) => {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    alert('ุดูุงุฑู ฺฉุงุฑุช ฺฉูพ ุดุฏ!');
  };

  const sendToTelegram = async () => {
    const caption = `<b>๐งพ ุฑุณุฏ ูพุฑุฏุงุฎุช ุฌุฏุฏ ุฏุฑุงูุช ุดุฏ</b>\n\n` +
                    `๐ ูุฏุช: ${months} ูุงู\n` +
                    `๐พ ุญุฌู: ${volume} ฺฏฺฏ\n` +
                    `๐ต ูุจูุบ: ${totalPrice.toLocaleString()} ุชููุงู\n` +
                    `๐ค ูุดุชุฑ: <code>${contact}</code>\n` +
                    `๐ ุขุฏ ุณุณุชู: <code>${user?.uid.substring(0, 8)}</code>`;

    const formData = new FormData();
    formData.append('chat_id', CHAT_ID);
    formData.append('caption', caption);
    formData.append('parse_mode', 'HTML');
    formData.append('photo', receiptImage);

    try {
      await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
        method: 'POST',
        body: formData
      });
    } catch (e) {
      console.error("ุฎุทุง ุฏุฑ ุงุฑุณุงู ุจู ุชูฺฏุฑุงู:", e);
    }
  };

  const handleFinalSubmit = async () => {
    if (!receiptImage) {
      alert('ูุทูุงู ุนฺฉุณ ุฑุณุฏ ูพุฑุฏุงุฎุช ุฑุง ุขูพููุฏ ฺฉูุฏ');
      return;
    }
    setLoading(true);
    try {
      // ุฐุฎุฑู ูุชุงุฏุชุง ุฏุฑ ุฏุชุงุจุณ
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
        userId: user.uid,
        contact, months, volume, totalPrice,
        hasReceipt: true,
        createdAt: new Date().toISOString()
      });

      await sendToTelegram();
      setIsSuccess(true);
    } catch (e) {
      alert('ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ');
    } finally {
      setLoading(false);
    }
  };

  if (isSuccess) {
    return (
      <div className="min-h-screen bg-slate-950 text-white flex items-center justify-center p-6 text-center" dir="rtl">
        <div className="space-y-6 max-w-sm animate-in">
          <div className="w-24 h-24 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto border border-emerald-500/40">
            <CheckCircle size={48} className="text-emerald-500" />
          </div>
          <h1 className="text-3xl font-bold">ุชุฃุฏ ุดุฏ!</h1>
          <p className="text-slate-400 text-sm leading-relaxed">
            ุฑุณุฏ ุดูุง ุจุง ููููุช ุจุฑุง ูุฏุฑุช ุงุฑุณุงู ุดุฏ. ูพุณ ุงุฒ ุจุฑุฑุณ ูุงุฑุฒุ ูุดุฎุตุงุช ุงุชุตุงู ุฏุฑ ุชูฺฏุฑุงู ุจุฑุง ุดูุง ูุฑุณุชุงุฏู ูโุดูุฏ.
          </p>
          <button onClick={() => window.location.reload()} className="w-full bg-slate-800 py-4 rounded-2xl font-bold">ุจุงุฒฺฏุดุช</button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#020617] text-slate-200 p-4 md:p-10 font-sans" dir="rtl">
      <div className="max-w-xl mx-auto">
        <div className="text-center mb-10">
          <h1 className="text-4xl font-black text-white italic">NEXT<span className="text-sky-500 underline decoration-sky-500/30">VPN</span></h1>
        </div>

        <div className="bg-slate-900/50 border border-slate-800 rounded-[3rem] overflow-hidden backdrop-blur-2xl shadow-2xl">
          <div className="flex bg-slate-900/80 border-b border-slate-800 text-[10px] font-bold text-slate-500">
            <div className={`flex-1 py-4 text-center ${step === 1 ? 'text-sky-500 bg-sky-500/5' : ''}`}>ฑ. ุงูุชุฎุงุจ ุณุฑูุณ</div>
            <div className={`flex-1 py-4 text-center ${step === 2 ? 'text-sky-500 bg-sky-500/5' : ''}`}>ฒ. ุงุทูุงุนุงุช ูุดุชุฑ</div>
            <div className={`flex-1 py-4 text-center ${step === 3 ? 'text-sky-500 bg-sky-500/5' : ''}`}>ณ. ูพุฑุฏุงุฎุช ู ุฑุณุฏ</div>
          </div>

          <div className="p-8 md:p-12">
            {step === 1 && (
              <div className="space-y-10 animate-in">
                <div className="space-y-6">
                  <div className="flex justify-between items-center"><label className="text-sm font-bold text-slate-400">ูุฏุช ุงุนุชุจุงุฑ</label><span className="text-xl font-black text-white">{months} ูุงูู</span></div>
                  <input type="range" min="1" max="12" value={months} onChange={(e)=>setMonths(e.target.value)} className="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-sky-500" />
                </div>
                <div className="space-y-6">
                  <div className="flex justify-between items-center"><label className="text-sm font-bold text-slate-400">ุญุฌู ุชุฑุงูฺฉ</label><span className="text-xl font-black text-white">{volume} ฺฏฺฏ</span></div>
                  <input type="range" min="5" max="500" step="5" value={volume} onChange={(e)=>setVolume(e.target.value)} className="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-purple-500" />
                </div>
                <div className="bg-slate-950/80 p-6 rounded-[2rem] border border-slate-800 flex justify-between items-center shadow-inner">
                  <span className="text-slate-500 text-sm">ูุจูุบ ููุง:</span>
                  <div className="text-left"><span className="text-3xl font-black text-sky-500">{totalPrice.toLocaleString()}</span><span className="text-[10px] text-slate-600 mr-1 italic">Toman</span></div>
                </div>
                <button onClick={()=>setStep(2)} className="w-full bg-sky-600 hover:bg-sky-500 py-5 rounded-2xl font-bold flex justify-center items-center gap-2 transition-all shadow-lg shadow-sky-600/20">ุชุงุฏ ู ุงุฏุงูู <ArrowRight size={20}/></button>
              </div>
            )}

            {step === 2 && (
              <div className="space-y-8 animate-in">
                <div className="space-y-4">
                   <h3 className="text-xl font-bold">ุงุทูุงุนุงุช ุงุชุตุงู</h3>
                   <p className="text-slate-500 text-sm">ุดูุงุฑู ููุจุงู ุง ุขุฏ ุชูฺฏุฑุงู ุฎูุฏ ุฑุง ุฌูุช ุงุฑุณุงู ุงฺฉุงูุช ูุงุฑุฏ ฺฉูุฏ.</p>
                   <div className="relative">
                      <User className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-600" size={20}/>
                      <input type="text" value={contact} onChange={(e)=>setContact(e.target.value)} placeholder="@Username / 0912..." className="w-full bg-slate-950 border border-slate-800 rounded-2xl p-5 pr-12 focus:border-sky-500 outline-none" />
                   </div>
                </div>
                <button onClick={()=>setStep(3)} className="w-full bg-sky-600 py-5 rounded-2xl font-bold shadow-lg shadow-sky-600/20">ุฑูุชู ุจู ูุฑุญูู ูพุฑุฏุงุฎุช</button>
                <button onClick={()=>setStep(1)} className="w-full text-slate-600 text-xs">ุจุงุฒฺฏุดุช ู ุงุตูุงุญ ูพูู</button>
              </div>
            )}

            {step === 3 && (
              <div className="space-y-8 animate-in">
                <div className="bg-slate-950 p-6 rounded-3xl border border-slate-800 text-center space-y-4">
                   <div className="text-xs text-slate-500 uppercase tracking-widest">ุดูุงุฑู ฺฉุงุฑุช ุฌูุช ูุงุฑุฒ</div>
                   <div className="text-xl font-black text-white tracking-[0.2em]">{CARD_NUMBER}</div>
                   <div className="text-xs text-slate-400 font-bold">{CARD_NAME}</div>
                   <button onClick={()=>copyToClipboard(CARD_NUMBER)} className="flex items-center gap-1 mx-auto text-sky-500 text-[10px] hover:underline"><Copy size={12}/> ฺฉูพ ุดูุงุฑู ฺฉุงุฑุช</button>
                </div>

                <div className="space-y-4">
                  <h3 className="text-lg font-bold flex items-center gap-2"><Camera size={20} className="text-sky-500" /> ุขูพููุฏ ุนฺฉุณ ุฑุณุฏ</h3>
                  <div 
                    onClick={() => document.getElementById('file-upload').click()}
                    className="border-2 border-dashed border-slate-800 rounded-3xl p-8 flex flex-col items-center gap-3 cursor-pointer hover:bg-slate-800/20 transition-all overflow-hidden"
                  >
                    {previewUrl ? (
                      <img src={previewUrl} className="w-full h-40 object-cover rounded-xl" alt="Preview" />
                    ) : (
                      <>
                        <ImageIcon size={40} className="text-slate-700" />
                        <span className="text-xs text-slate-500">ุจุฑุง ุงูุชุฎุงุจ ุนฺฉุณ ฺฉูฺฉ ฺฉูุฏ</span>
                      </>
                    )}
                    <input id="file-upload" type="file" accept="image/*" onChange={handleImageChange} className="hidden" />
                  </div>
                </div>

                <div className="p-4 bg-amber-500/5 border border-amber-500/10 rounded-2xl flex gap-3 italic">
                  <Info size={18} className="text-amber-600 shrink-0" />
                  <p className="text-[10px] text-slate-500 leading-relaxed">ูุจูุบ ูุงุฑุฒ ุฏููุงู ุจุงุฏ <b>{totalPrice.toLocaleString()} ุชููุงู</b> ุจุงุดุฏ. ูพุณ ุงุฒ ุชุฃุฏุ ุงฺฉุงูุช ุจุฑุง ุดูุง ูุนุงู ูโุดูุฏ.</p>
                </div>

                <button 
                  disabled={loading || !receiptImage}
                  onClick={handleFinalSubmit}
                  className={`w-full py-5 rounded-2xl font-bold flex items-center justify-center gap-3 transition-all ${loading || !receiptImage ? 'bg-slate-800' : 'bg-emerald-600 hover:bg-emerald-500 shadow-lg shadow-emerald-900/20'}`}
                >
                  {loading ? <Loader2 className="animate-spin" /> : <><Send size={18}/> ุซุจุช ููุง ู ุงุฑุณุงู ุฑุณุฏ</>}
                </button>
                <button onClick={()=>setStep(2)} className="w-full text-slate-600 text-xs">ุจุงุฒฺฏุดุช</button>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

